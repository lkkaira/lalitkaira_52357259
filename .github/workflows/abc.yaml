name: Deploy Azure Infrastructure with Terraform
 
on:
  push:
    branches:
      - main
 
jobs:
  # ------------------- PLAN JOB -------------------
  terraform-plan:
    runs-on: ubuntu-latest
    steps:
      # Checkout code
      - name: Checkout repository
        uses: actions/checkout@v3
 
      # Install Terraform
      - name: Install Terraform
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip
          wget https://releases.hashicorp.com/terraform/1.5.7/terraform_1.5.7_linux_amd64.zip
          unzip terraform_1.5.7_linux_amd64.zip
          sudo mv terraform /usr/local/bin/
          terraform -version
 
      # Login to Azure
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
 
      # Terraform Init & Plan
      - name: Terraform Init & Plan
        working-directory: RootModule
        run: |
          terraform init
          terraform plan -out=tfplan
 
      # Upload Plan Artifact
      - name: Upload Terraform Plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: |
            RootModule/tfplan
            RootModule/.terraform.lock.hcl
 
  # ------------------- APPLY JOB -------------------
  terraform-apply:
    runs-on: ubuntu-latest
    needs: terraform-plan
    steps:
      # Checkout code
      - name: Checkout repository
        uses: actions/checkout@v3
 
      # Install Terraform
      - name: Install Terraform
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip
          wget https://releases.hashicorp.com/terraform/1.5.7/terraform_1.5.7_linux_amd64.zip
          unzip terraform_1.5.7_linux_amd64.zip
          sudo mv terraform /usr/local/bin/
          terraform -version
 
      # Login to Azure
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
 
      # Download Plan Artifact
      - name: Download Terraform Plan
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan
          path: RootModule
 
      # Apply Terraform Plan
      - name: Terraform Apply
        working-directory: RootModule
        run: |
          ls -l  # Debug: confirm tfplan exists
          terraform init   # âœ… Required to restore providers and backend
          terraform apply -auto-approve tfplan
